  internal sealed class MariaAckDAL : MariaDALBase, IAckDAL {
      public MariaAckDAL(IWorkFlowDALUtil db) : base(db) { }

      public Task<DbRow?> GetByIdAsync(long ackId, DbExecutionLoad load = default)
          => Db.RowAsync(QRY_ACK.GET_BY_ID, load, (ID, ackId));

      public Task<DbRow?> GetByGuidAsync(string guid, DbExecutionLoad load = default)
          => Db.RowAsync(QRY_ACK.GET_BY_GUID, load, (GUID, guid));

      public Task<long?> GetIdByGuidAsync(string guid, DbExecutionLoad load = default)
          => Db.ScalarAsync<long?>(QRY_ACK.GET_ID_BY_GUID, load, (GUID, guid));

      public Task<DbRow?> InsertReturnRowAsync(DbExecutionLoad load = default)
          => Db.RowAsync(QRY_ACK.INSERT, load);

      public Task<DbRow?> InsertWithGuidReturnRowAsync(string guid, DbExecutionLoad load = default)
          => Db.RowAsync(QRY_ACK.INSERT_WITH_GUID, load, (GUID, guid));

      public Task<int> DeleteAsync(long ackId, DbExecutionLoad load = default)
          => Db.ExecAsync(QRY_ACK.DELETE, load, (ID, ackId));
  }

    internal sealed class MariaAckConsumerDAL : MariaDALBase, IAckConsumerDAL {
      public MariaAckConsumerDAL(IWorkFlowDALUtil db) : base(db) { }
      public Task<DbRow?> GetByKeyAsync(long ackId, long consumer, DbExecutionLoad load = default)
          => Db.RowAsync(QRY_ACK_CONSUMER.GET_BY_KEY, load, (ACK_ID, ackId), (CONSUMER_ID, consumer)); // FIXED

      public Task<DbRow?> GetByAckGuidAndConsumerAsync(string ackGuid, long consumer, DbExecutionLoad load = default)
          => Db.RowAsync(QRY_ACK_CONSUMER.GET_BY_ACK_GUID_AND_CONSUMER, load, (GUID, ackGuid), (CONSUMER_ID, consumer));

      public Task<long> UpsertByAckIdAndConsumerReturnIdAsync(long ackId, long consumer, int status, DateTime? utcNextDue, DbExecutionLoad load = default)
          => Db.ScalarAsync<long>(QRY_ACK_CONSUMER.UPSERT_RETURN_ID, load, (ACK_ID, ackId),(CONSUMER_ID, consumer),(ACK_STATUS, status), (NEXT_DUE, utcNextDue));

      public Task<int> SetStatusAndDueAsync(long ackId, long consumer, int status, DateTime? utcNextDue, DbExecutionLoad load = default)
          => Db.ExecAsync(QRY_ACK_CONSUMER.SET_STATUS_AND_DUE, load, (ACK_ID, ackId), (CONSUMER_ID, consumer),(ACK_STATUS, status), (NEXT_DUE, utcNextDue));

      public Task<int> SetStatusAndDueByGuidAsync(string ackGuid, long consumer, int status, DateTime? utcNextDue, DbExecutionLoad load = default)
          => Db.ExecAsync(QRY_ACK_CONSUMER.SET_STATUS_AND_DUE_BY_GUID, load, (GUID, ackGuid), (CONSUMER_ID, consumer),(ACK_STATUS, status),(NEXT_DUE, utcNextDue));

      public Task<int> MarkTriggerAsync(long ackId, long consumer, DateTime? utcNextDue, DbExecutionLoad load = default)
          => Db.ExecAsync(QRY_ACK_CONSUMER.MARK_TRIGGER, load,(ACK_ID, ackId),(CONSUMER_ID, consumer),(NEXT_DUE, utcNextDue));

      public Task<DbRows> ListDueByStatusPagedAsync(int status, int skip, int take, DbExecutionLoad load = default)
          => Db.RowsAsync(QRY_ACK_CONSUMER.LIST_DUE_BY_STATUS_PAGED, load,(ACK_STATUS, status),(SKIP, skip),(TAKE, take));

      public Task<DbRows> ListDueByConsumerAndStatusPagedAsync(long consumer, int status, int skip, int take, DbExecutionLoad load = default)
          => Db.RowsAsync(QRY_ACK_CONSUMER.LIST_DUE_BY_CONSUMER_AND_STATUS_PAGED, load,(CONSUMER_ID, consumer), (ACK_STATUS, status),(SKIP, skip),(TAKE, take));

      // Keep these if you still want “non-due” browsing screens:
      public Task<DbRows> ListByStatusPagedAsync(int status, int skip, int take, DbExecutionLoad load = default)
          => Db.RowsAsync(QRY_ACK_CONSUMER.LIST_BY_STATUS_PAGED, load, (ACK_STATUS, status), (SKIP, skip), (TAKE, take));

      public Task<DbRows> ListByConsumerAndStatusPagedAsync(long consumer, int status, int skip, int take, DbExecutionLoad load = default)
          => Db.RowsAsync(QRY_ACK_CONSUMER.LIST_BY_CONSUMER_AND_STATUS_PAGED, load, (CONSUMER_ID, consumer), (ACK_STATUS, status), (SKIP, skip), (TAKE, take));
  }

 internal sealed class MariaInstanceDAL : MariaDALBase, IInstanceDAL {
     public MariaInstanceDAL(IWorkFlowDALUtil db) : base(db) { }

     public Task<DbRow?> GetByGuidAsync(string guid, DbExecutionLoad load = default)
         => Db.RowAsync(QRY_INSTANCE.GET_BY_GUID, load, (GUID, guid));

     public Task<long?> GetIdByGuidAsync(string guid, DbExecutionLoad load = default)
         => Db.ScalarAsync<long?>(QRY_INSTANCE.GET_ID_BY_GUID, load, (GUID, guid));

     public Task<long?> GetIdByKeyAsync(long defVersionId, string externalRef, DbExecutionLoad load = default)
         => Db.ScalarAsync<long?>(QRY_INSTANCE.GET_ID_BY_PARENT_AND_EXTERNAL_REF, load, (PARENT_ID, defVersionId), (EXTERNAL_REF, externalRef));

     public async Task<string?> UpsertByKeyReturnGuidAsync(long defVersionId, string externalRef, long currentStateId, long? lastEventId, long policyId, uint flags, DbExecutionLoad load = default) {
         var exists = await Db.ScalarAsync<string?>(QRY_INSTANCE.GET_GUID_BY_PARENT_AND_EXTERNAL_REF, load, (PARENT_ID, defVersionId), (EXTERNAL_REF, externalRef));
         if (!string.IsNullOrWhiteSpace(exists)) return exists;
         return await Db.ScalarAsync<string?>(QRY_INSTANCE.INSERT, load, (PARENT_ID, defVersionId), (EXTERNAL_REF, externalRef), (STATE_ID, currentStateId), (EVENT_ID, lastEventId), (POLICY_ID, policyId), (FLAGS, flags));
     }
     
     public Task<int> UpdateCurrentStateCasAsync(long instanceId, long expectedFromStateId, long newToStateId, long? lastEventId, DbExecutionLoad load = default)
         => Db.ExecAsync(QRY_INSTANCE.UPDATE_CURRENT_STATE_CAS, load, (ID, instanceId), (FROM_ID, expectedFromStateId), (TO_ID, newToStateId), (EVENT_ID, lastEventId));

     public Task<int> SetPolicyAsync(long instanceId, long policyId, DbExecutionLoad load = default)
         => Db.ExecAsync(QRY_INSTANCE.SET_POLICY, load, (ID, instanceId), (POLICY_ID, policyId));

     public Task<int> AddFlagsAsync(long instanceId, uint flags, DbExecutionLoad load = default)
         => Db.ExecAsync(QRY_INSTANCE.ADD_FLAGS, load, (ID, instanceId), (FLAGS, flags));

     public Task<int> RemoveFlagsAsync(long instanceId, uint flags, DbExecutionLoad load = default)
         => Db.ExecAsync(QRY_INSTANCE.REMOVE_FLAGS, load, (ID, instanceId), (FLAGS, flags));
 }

 public class MariaWorkFlowDALUtil : IWorkFlowDALUtil {
     private readonly IAdapterGateway _agw;
     protected readonly string _key;

     public MariaWorkFlowDALUtil(IAdapterGateway agw, string key) {
         _agw = agw ?? throw new ArgumentNullException(nameof(agw));
         _key = key ?? throw new ArgumentNullException(nameof(key));
     }

     public async Task<int> ExecAsync(string sql, DbExecutionLoad load = default, params DbArg[] args) {
         load.Ct.ThrowIfCancellationRequested();
         var fb = await _agw.NonQueryAsync(new AdapterArgs(_key) { Query = sql}.ForTransaction(load.Handler,false), ToAgwArgs(args));
         if (!fb.Status) throw new InvalidOperationException(fb.Message ?? "NonQuery failed.");
         return fb.Result;
     }
     public async Task<T?> ScalarAsync<T>(string sql, DbExecutionLoad load = default, params DbArg[] args) {
         load.Ct.ThrowIfCancellationRequested();
         var fb = await _agw.ScalarAsync<T>(new AdapterArgs(_key) { Query = sql }.ForTransaction(load.Handler, false), ToAgwArgs(args));
         if (!fb.Status) throw new InvalidOperationException(fb.Message ?? "Scalar failed.");
         return fb.Result;
     }
     public async Task<DbRow?> RowAsync(string sql, DbExecutionLoad load = default, params DbArg[] args) {
         load.Ct.ThrowIfCancellationRequested();
         var fb = await _agw.ReadSingleAsync(new AdapterArgs(_key) { Query = sql }.ForTransaction(load.Handler, false), ToAgwArgs(args));
         if (!fb.Status) throw new InvalidOperationException(fb.Message ?? "ReadSingle failed.");
         return fb.Result;
     }
     public async Task<DbRows> RowsAsync(string sql, DbExecutionLoad load = default, params DbArg[] args) {
         load.Ct.ThrowIfCancellationRequested();
         var fb = await _agw.ReadAsync(new AdapterArgs(_key) { Query = sql }.ForTransaction(load.Handler, false), ToAgwArgs(args));
         if (!fb.Status) throw new InvalidOperationException(fb.Message ?? "Read failed.");
         return fb.Result;
     }

     private static (string key, object value)[] ToAgwArgs(DbArg[]? args) {
         if (args == null || args.Length == 0) return Array.Empty<(string key, object value)>();

         var arr = new (string key, object value)[args.Length];
         for (int i = 0; i < args.Length; i++) {
             // AGW expects object (non-nullable) — convert null to DBNull.Value (safe for DB)
             var v = args[i].Value ?? DBNull.Value;
             arr[i] = (args[i].Name, v);
         }
         return arr;
     }
     public ValueTask DisposeAsync() => ValueTask.CompletedTask;

     public ITransactionHandler CreateNewTransaction() {
         return _agw.GetTransactionHandler(_key);
     }
 }


   public class MariaWorkFlowDAL : MariaWorkFlowDALUtil, IWorkFlowDAL {
      public IBlueprintReadDAL Blueprint { get; }
      public IBlueprintWriteDAL BlueprintWrite { get; }
      public IInstanceDAL Instance { get; }
      public ILifeCycleDAL LifeCycle { get; }
      public ILifeCycleDataDAL LifeCycleData { get; }
      public IHookDAL Hook { get; }
      public IAckDAL Ack { get; }
      public IAckConsumerDAL AckConsumer { get; }
      public ILcAckDAL LcAck { get; }
      public IHookAckDAL HookAck { get; }
      public IAckDispatchDAL AckDispatch { get; }
      public IActivityDAL Activity { get; }
      public IActivityStatusDAL ActivityStatus { get; }
      public IRuntimeDAL Runtime { get; }
      public IRuntimeDataDAL RuntimeData { get; }

      public MariaWorkFlowDAL(IAdapterGateway agw, string key) : base(agw, key) {
          Blueprint = new MariaBlueprintReadDAL(this);
          BlueprintWrite = new MariaBlueprintWriteDAL(this);
          Instance = new MariaInstanceDAL(this);
          LifeCycle = new MariaLifeCycleDAL(this);
          LifeCycleData = new MariaLifeCycleDataDAL(this);
          Hook = new MariaHookDAL(this);

          Ack = new MariaAckDAL(this);
          AckConsumer = new MariaAckConsumerDAL(this);
          LcAck = new MariaLcAckDAL(this);
          HookAck = new MariaHookAckDAL(this);
          AckDispatch = new MariaAckDispatchDAL(this);

          Activity = new MariaActivityDAL(this);
          ActivityStatus = new MariaActivityStatusDAL(this);

          Runtime = new MariaRuntimeDAL(this);
          RuntimeData = new MariaRuntimeDataDAL(this);
      }
  }