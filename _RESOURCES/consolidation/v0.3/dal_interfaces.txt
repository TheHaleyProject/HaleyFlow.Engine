  public interface IAckDAL {
      Task<DbRow?> GetByIdAsync(long ackId, DbExecutionLoad load = default);
      Task<DbRow?> GetByGuidAsync(string guid, DbExecutionLoad load = default);
      Task<long?> GetIdByGuidAsync(string guid, DbExecutionLoad load = default);

      Task<DbRow?> InsertReturnRowAsync(DbExecutionLoad load = default);
      Task<DbRow?> InsertWithGuidReturnRowAsync(string guid, DbExecutionLoad load = default);
      Task<int> DeleteAsync(long ackId, DbExecutionLoad load = default);
  }

  public interface IAckConsumerDAL {
      Task<DbRow?> GetByKeyAsync(long ackId, long consumer, DbExecutionLoad load = default);
      Task<DbRow?> GetByAckGuidAndConsumerAsync(string ackGuid, long consumer, DbExecutionLoad load = default);
      Task<long> UpsertByAckIdAndConsumerReturnIdAsync(long ackId, long consumer, int status, DbExecutionLoad load = default);
      Task<int> SetStatusAsync(long ackId, long consumer, int status, DbExecutionLoad load = default);
      Task<int> SetStatusByGuidAsync(string ackGuid, long consumer, int status, DbExecutionLoad load = default);
      Task<int> MarkRetryAsync(long ackId, long consumer, DbExecutionLoad load = default);
      Task<DbRows> ListByStatusPagedAsync(int status, int skip, int take, DbExecutionLoad load = default);
      Task<DbRows> ListByConsumerAndStatusPagedAsync(long consumer, int status, int skip, int take, DbExecutionLoad load = default);
      Task<DbRows> ListReadyForRetryAsync(int status, DateTime utcOlderThan, DbExecutionLoad load = default);
  }

  public interface IAckDispatchDAL {
      Task<DbRows> ListPendingLifecycleReadyPagedAsync(long consumer, int status, DateTime utcOlderThan, int skip, int take, DbExecutionLoad load = default);
      Task<DbRows> ListPendingHookReadyPagedAsync(long consumer, int status, DateTime utcOlderThan, int skip, int take, DbExecutionLoad load = default);
      Task<int?> CountPendingLifecycleReadyAsync(int status, DateTime utcOlderThan, DbExecutionLoad load = default);
      Task<int?> CountPendingHookReadyAsync(int status, DateTime utcOlderThan, DbExecutionLoad load = default);
  }

  public interface IHookAckDAL {
      Task<long?> GetAckIdByHookIdAsync(long hookId, DbExecutionLoad load = default);
      Task<int> AttachAsync(long ackId, long hookId, DbExecutionLoad load = default);
      Task<int> DeleteByHookIdAsync(long hookId, DbExecutionLoad load = default);
  }

  public interface ILcAckDAL {
      Task<long?> GetAckIdByLcIdAsync(long lcId, DbExecutionLoad load = default);
      Task<int> AttachAsync(long ackId, long lcId, DbExecutionLoad load = default);
      Task<int> DeleteByLcIdAsync(long lcId, DbExecutionLoad load = default);
  }

  public interface IBlueprintReadDAL {
    Task<DbRow?> GetLatestDefVersionByEnvCodeAndDefNameAsync(int envCode, string defName, DbExecutionLoad load = default);
    Task<DbRow?> GetLatestDefVersionByEnvNameAndDefNameAsync(string envName, string defName, DbExecutionLoad load = default);
    Task<DbRow?> GetLatestDefVersionByDefinitionGuidAsync(string defGuid, DbExecutionLoad load = default);
    Task<DbRow?> GetLatestDefVersionByLineFromDefVersionIdAsync(long defVersionId, DbExecutionLoad load = default);
    Task<DbRow?> GetLatestDefVersionByLineFromDefVersionGuidAsync(string defVersionGuid, DbExecutionLoad load = default);
    Task<int?> GetNextDefVersionNumberByEnvCodeAndDefNameAsync(int envCode, string defName, DbExecutionLoad load = default);

    Task<DbRow?> GetDefVersionByIdAsync(long defVersionId, DbExecutionLoad load = default);

    Task<DbRows> ListStatesAsync(long defVersionId, DbExecutionLoad load = default);
    Task<DbRows> ListEventsAsync(long defVersionId, DbExecutionLoad load = default);
    Task<DbRows> ListTransitionsAsync(long defVersionId, DbExecutionLoad load = default);

    Task<DbRow?> GetPolicyByIdAsync(long policyId, DbExecutionLoad load = default);
    Task<DbRow?> GetPolicyByHashAsync(string hash, DbExecutionLoad load = default);

    // policy attached to state/transition (your "policy json included on transition" concept)
    Task<DbRow?> GetPolicyForStateAsync(long definitionId, long stateId, DbExecutionLoad load = default);
}

// IBlueprintWriteDAL.cs
public interface IBlueprintWriteDAL {
    Task<int> EnsureEnvironmentByCodeAsync(int envCode, string envDisplayName, DbExecutionLoad load = default);
    Task<int> EnsureDefinitionByEnvIdAsync(int envId, string defDisplayName, string? description, DbExecutionLoad load = default);
    Task<long> InsertDefVersionAsync(int definitionId, int version, string data, DbExecutionLoad load = default);
    Task<int> EnsureCategoryByNameAsync(string displayName, DbExecutionLoad load = default);
    Task<int> InsertEventAsync(long defVersionId, string displayName, int code, DbExecutionLoad load = default);
    Task<int> InsertStateAsync(long defVersionId, int categoryId, string displayName, uint flags, int? timeoutMinutes, uint timeoutMode, long? timeoutEventId, DbExecutionLoad load = default);
    Task<int> InsertTransitionAsync(long defVersionId, int fromStateId, int toStateId, int eventId, DbExecutionLoad load = default);
    Task<long> EnsurePolicyByHashAsync(string hash, string content, DbExecutionLoad load = default);
    Task<int> AttachPolicyToDefinitionByEnvCodeAndDefNameAsync(int envCode, string defName, long policyId, DbExecutionLoad load = default);
}

 public interface IInstanceDAL {
     Task<DbRow?> GetByGuidAsync(string guid, DbExecutionLoad load = default);
     Task<long?> GetIdByGuidAsync(string guid, DbExecutionLoad load = default);

     Task<long?> GetIdByKeyAsync(long defVersionId, string externalRef, DbExecutionLoad load = default);
     Task<string?> UpsertByKeyReturnGuidAsync(long defVersionId, string externalRef, long currentStateId, long? lastEventId, long policyId, uint flags, DbExecutionLoad load = default);
     Task<int> UpdateCurrentStateCasAsync(long instanceId, long expectedFromStateId, long newToStateId, long? lastEventId, DbExecutionLoad load = default);

     Task<int> SetPolicyAsync(long instanceId, long policyId, DbExecutionLoad load = default);
     Task<int> AddFlagsAsync(long instanceId, uint flags, DbExecutionLoad load = default);
     Task<int> RemoveFlagsAsync(long instanceId, uint flags, DbExecutionLoad load = default);
 }

 public interface IHookDAL {
     Task<DbRow?> GetByIdAsync(long hookId, DbExecutionLoad load = default);
     Task<DbRow?> GetByKeyAsync(long instanceId, long stateId, long viaEventId, bool onEntry, string route, DbExecutionLoad load = default);
     Task<long> UpsertByKeyReturnIdAsync(long instanceId, long stateId, long viaEventId, bool onEntry, string route, DbExecutionLoad load = default);
     Task<DbRows> ListByInstanceAsync(long instanceId, DbExecutionLoad load = default);
     Task<DbRows> ListByInstanceAndStateAsync(long instanceId, long stateId, DbExecutionLoad load = default);
     Task<int> DeleteAsync(long hookId, DbExecutionLoad load = default);
     Task<int> DeleteByInstanceAsync(long instanceId, DbExecutionLoad load = default);
 }

 public interface ILifeCycleDAL {
     Task<long> InsertAsync(long instanceId, long fromStateId, long toStateId, long eventId, DbExecutionLoad load = default);
     Task<DbRow?> GetLastByInstanceAsync(long instanceId, DbExecutionLoad load = default);
     Task<DbRows> ListByInstanceAsync(long instanceId, DbExecutionLoad load = default);
     Task<DbRows> ListByInstancePagedAsync(long instanceId, int skip, int take, DbExecutionLoad load = default);
     Task<string?> GetTimelineJsonByInstanceIdAsync(long instanceId, DbExecutionLoad load = default);
 }

 public interface ILifeCycleDataDAL {
     Task<DbRow?> GetByIdAsync(long lifeCycleId, DbExecutionLoad load = default);
     Task<int> UpsertAsync(long lifeCycleId, string? actor, string? payloadJson, DbExecutionLoad load = default);
     Task<int> DeleteAsync(long lifeCycleId, DbExecutionLoad load = default);
 }

    public interface IRuntimeDAL {
       Task<DbRow?> GetByIdAsync(long runtimeId, DbExecutionLoad load = default);
       Task<DbRow?> GetByKeyAsync(long instanceId, long activityId, long stateId, string actorId, DbExecutionLoad load = default);
       Task<long> UpsertByKeyReturnIdAsync(long instanceId, long activityId, long stateId, string actorId, long statusId, long lcId, bool frozen, DbExecutionLoad load = default);
       Task<int> SetStatusAsync(long runtimeId, long statusId, DbExecutionLoad load = default);
       Task<int> SetFrozenAsync(long runtimeId, bool frozen, DbExecutionLoad load = default);
       Task<int> SetLcIdAsync(long runtimeId, long lcId, DbExecutionLoad load = default);
       Task<DbRows> ListByInstanceAsync(long instanceId, DbExecutionLoad load = default);
       Task<DbRows> ListByInstanceAndStateAsync(long instanceId, long stateId, DbExecutionLoad load = default);
       Task<DbRows> ListByInstanceStateActivityAsync(long instanceId, long stateId, long activityId, DbExecutionLoad load = default);
       Task<DbRows> ListByLifeCycleAsync(long lcId, DbExecutionLoad load = default);
   }

   public interface IRuntimeDataDAL {
       Task<DbRow?> GetByIdAsync(long runtimeId, DbExecutionLoad load = default);
       Task<int> UpsertAsync(long runtimeId, string? dataJson, string? payloadJson, DbExecutionLoad load = default);
       Task<int> DeleteAsync(long runtimeId, DbExecutionLoad load = default);
   }

   public interface IActivityDAL {
       Task<DbRows> ListAllAsync(DbExecutionLoad load = default);
       Task<DbRow?> GetByIdAsync(long id, DbExecutionLoad load = default);
       Task<DbRow?> GetByNameAsync(string name, DbExecutionLoad load = default);
       Task<long> InsertAsync(string displayName, DbExecutionLoad load = default);
   }

   public interface IActivityStatusDAL {
       Task<DbRows> ListAllAsync(DbExecutionLoad load = default);
       Task<DbRow?> GetByIdAsync(long id, DbExecutionLoad load = default);
       Task<DbRow?> GetByNameAsync(string name, DbExecutionLoad load = default);
       Task<long> InsertAsync(string displayName, DbExecutionLoad load = default);
   }

     public interface IWorkFlowDAL : IWorkFlowDALUtil {
      IBlueprintReadDAL Blueprint { get; }
      IBlueprintWriteDAL BlueprintWrite { get; }
      IInstanceDAL Instance { get; }
      ILifeCycleDAL LifeCycle { get; }
      ILifeCycleDataDAL LifeCycleData { get; }
      IHookDAL Hook { get; }
      IAckDAL Ack { get; }
      IAckConsumerDAL AckConsumer { get; }
      ILcAckDAL LcAck { get; }
      IHookAckDAL HookAck { get; }
      IAckDispatchDAL AckDispatch { get; }
      IActivityDAL Activity { get; }
      IActivityStatusDAL ActivityStatus { get; }
      IRuntimeDAL Runtime { get; }
      IRuntimeDataDAL RuntimeData { get; }
  }

  public interface IWorkFlowDALUtil : IAsyncDisposable {
    Task<int> ExecAsync(string sql, DbExecutionLoad load = default, params DbArg[] args);
    Task<T?> ScalarAsync<T>(string sql, DbExecutionLoad load = default , params DbArg[] args);
    Task<DbRow?> RowAsync(string sql, DbExecutionLoad load = default, params DbArg[] args);
    Task<DbRows> RowsAsync(string sql, DbExecutionLoad load = default, params DbArg[] args);
    ITransactionHandler CreateNewTransaction();
}