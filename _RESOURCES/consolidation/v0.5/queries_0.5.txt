internal class QRY_ACK {
    public const string EXISTS_BY_ID = $@"SELECT 1 FROM ack WHERE id = {ID} LIMIT 1;";
    public const string EXISTS_BY_GUID = $@"SELECT 1 FROM ack WHERE guid = lower(trim({GUID})) LIMIT 1;";

    public const string GET_BY_ID = $@"SELECT * FROM ack WHERE id = {ID} LIMIT 1;";
    public const string GET_BY_GUID = $@"SELECT * FROM ack WHERE guid = lower(trim({GUID})) LIMIT 1;";

    public const string GET_ID_BY_GUID = $@"SELECT id FROM ack WHERE guid = lower(trim({GUID})) LIMIT 1;";
    public const string GET_GUID_BY_ID = $@"SELECT guid FROM ack WHERE id = {ID} LIMIT 1;";

    // creates a new ack; returns both id + guid (engine needs id for link tables, guid for app)
    public const string INSERT = $@"INSERT INTO ack () VALUES (); SELECT id AS id, guid AS guid FROM ack WHERE id = LAST_INSERT_ID() LIMIT 1;";

    public const string INSERT_WITH_GUID = $@"INSERT INTO ack (guid) VALUES (lower(trim({GUID}))); SELECT id AS id, guid AS guid FROM ack WHERE id = LAST_INSERT_ID() LIMIT 1;";

    public const string DELETE = $@"DELETE FROM ack WHERE id = {ID};";
}
internal class QRY_ACK_CONSUMER {

    public const string EXISTS_BY_ID = $@"SELECT 1 FROM ack_consumer WHERE id = {ID} LIMIT 1;";
    public const string EXISTS_BY_ACK_ID_AND_CONSUMER = $@"SELECT 1 FROM ack_consumer WHERE ack_id = {ACK_ID} AND consumer = {CONSUMER_ID} LIMIT 1;";

    public const string GET_BY_ID = $@"SELECT * FROM ack_consumer WHERE id = {ID} LIMIT 1;";
    public const string GET_BY_ACK_ID_AND_CONSUMER = $@"SELECT * FROM ack_consumer WHERE ack_id = {ACK_ID} AND consumer = {CONSUMER_ID} LIMIT 1;";
    public const string GET_BY_ACK_GUID_AND_CONSUMER = $@"SELECT ac.* FROM ack_consumer ac JOIN ack a ON a.id = ac.ack_id WHERE a.guid = lower(trim({GUID})) AND ac.consumer = {CONSUMER_ID} LIMIT 1;";
    public const string GET_BY_KEY = $@"SELECT * FROM ack_consumer WHERE ack_id = {ACK_ID} AND consumer = {CONSUMER_ID} LIMIT 1;";

    // inserts must return id; caller sets next_due (can be NULL)
    public const string UPSERT_RETURN_ID = $@"INSERT INTO ack_consumer (ack_id, consumer, status, next_due) VALUES ({ACK_ID}, {CONSUMER_ID}, {ACK_STATUS}, {NEXT_DUE}) ON DUPLICATE KEY UPDATE status = VALUES(status), next_due = VALUES(next_due), modified = CURRENT_TIMESTAMP, id = LAST_INSERT_ID(id); SELECT LAST_INSERT_ID() AS id;";

    // due queue (monitor)
    public const string LIST_DUE_BY_STATUS_PAGED = $@"SELECT ac.*, a.guid AS ack_guid, a.created AS ack_created FROM ack_consumer ac JOIN ack a ON a.id = ac.ack_id WHERE ac.status = {ACK_STATUS} AND ac.next_due IS NOT NULL AND ac.next_due <= UTC_TIMESTAMP() ORDER BY ac.next_due ASC, ac.id ASC LIMIT {TAKE} OFFSET {SKIP};";
    public const string LIST_DUE_BY_CONSUMER_AND_STATUS_PAGED = $@"SELECT ac.*, a.guid AS ack_guid, a.created AS ack_created FROM ack_consumer ac JOIN ack a ON a.id = ac.ack_id WHERE ac.consumer = {CONSUMER_ID} AND ac.status = {ACK_STATUS} AND ac.next_due IS NOT NULL AND ac.next_due <= UTC_TIMESTAMP() ORDER BY ac.next_due ASC, ac.id ASC LIMIT {TAKE} OFFSET {SKIP};";

    // mark a trigger attempt + schedule next_due (caller decides next_due; can be NULL)
    public const string MARK_TRIGGER = $@"UPDATE ack_consumer SET trigger_count = trigger_count + 1, last_trigger = CURRENT_TIMESTAMP, next_due = {NEXT_DUE}, modified = CURRENT_TIMESTAMP WHERE ack_id = {ACK_ID} AND consumer = {CONSUMER_ID};";

    // status change + next_due management (Processed/Failed => pass NULL)
    public const string SET_STATUS_AND_DUE = $@"UPDATE ack_consumer SET status = {ACK_STATUS}, next_due = {NEXT_DUE}, modified = CURRENT_TIMESTAMP WHERE ack_id = {ACK_ID} AND consumer = {CONSUMER_ID};";
    public const string SET_STATUS_AND_DUE_BY_GUID = $@"UPDATE ack_consumer ac JOIN ack a ON a.id = ac.ack_id SET ac.status = {ACK_STATUS}, ac.next_due = {NEXT_DUE}, ac.modified = CURRENT_TIMESTAMP WHERE a.guid = lower(trim({GUID})) AND ac.consumer = {CONSUMER_ID};";

    public const string LIST_BY_STATUS_PAGED = $@"SELECT ac.*, a.guid AS ack_guid, a.created AS ack_created FROM ack_consumer ac JOIN ack a ON a.id = ac.ack_id WHERE ac.status = {ACK_STATUS} ORDER BY ac.modified DESC, ac.id DESC LIMIT {TAKE} OFFSET {SKIP};";
    public const string LIST_BY_CONSUMER_AND_STATUS_PAGED = $@"SELECT ac.*, a.guid AS ack_guid, a.created AS ack_created FROM ack_consumer ac JOIN ack a ON a.id = ac.ack_id WHERE ac.consumer = {CONSUMER_ID} AND ac.status = {ACK_STATUS} ORDER BY ac.modified DESC, ac.id DESC LIMIT {TAKE} OFFSET {SKIP};";
    public const string PUSH_NEXT_DUE_FOR_DOWN_BY_CONSUMER_AND_STATUS = @$"UPDATE ack_consumer ac JOIN consumer c ON c.id=ac.consumer SET ac.next_due=DATE_ADD(UTC_TIMESTAMP(), INTERVAL {RECHECK_SECONDS} SECOND) WHERE ac.consumer={CONSUMER_ID} AND ac.status={ACK_STATUS} AND ac.next_due IS NOT NULL AND ac.next_due <= UTC_TIMESTAMP() AND TIMESTAMPDIFF(SECOND, c.last_beat, UTC_TIMESTAMP()) > {TTL_SECONDS};";



    public const string DELETE = $@"DELETE FROM ack_consumer WHERE id = {ID};";
    public const string DELETE_BY_ACK_ID = $@"DELETE FROM ack_consumer WHERE ack_id = {ACK_ID};";
}
internal class QRY_ACK_HOOK {
    public const string EXISTS_BY_ACK_ID = $@"SELECT 1 FROM hook_ack WHERE ack_id = {ACK_ID} LIMIT 1;";
    public const string EXISTS_BY_HOOK_ID = $@"SELECT 1 FROM hook_ack WHERE hook_id = {HOOK_ID} LIMIT 1;";

    public const string GET_BY_HOOK_ID = $@"SELECT * FROM hook_ack WHERE hook_id = {HOOK_ID} LIMIT 1;";
    public const string GET_BY_ACK_ID = $@"SELECT * FROM hook_ack WHERE ack_id = {ACK_ID} LIMIT 1;";
    public const string GET_ACK_ID_BY_HOOK_ID = $@"SELECT ack_id AS id FROM hook_ack WHERE hook_id = {HOOK_ID} LIMIT 1;";

    // idempotent attach (hook_id is PK)
    public const string ATTACH = $@"INSERT INTO hook_ack (ack_id, hook_id) VALUES ({ACK_ID}, {HOOK_ID}) ON DUPLICATE KEY UPDATE ack_id = ack_id;";
    public const string DETACH = $@"DELETE FROM hook_ack WHERE hook_id = {HOOK_ID};";

    public const string DELETE_BY_ACK_ID = $@"DELETE FROM hook_ack WHERE ack_id = {ACK_ID};";
    public const string DELETE_BY_HOOK_ID = $@"DELETE FROM hook_ack WHERE hook_id = {HOOK_ID};";

    // Pending hook dispatch is now per consumer/status in ack_consumer
    public const string PENDING_ACKS = $@"SELECT a.id AS ack_id, a.guid AS ack_guid, ac.consumer, ac.status, ac.last_retry, ac.retry_count, h.* FROM hook_ack ha JOIN ack a ON a.id = ha.ack_id JOIN ack_consumer ac ON ac.ack_id = a.id JOIN hook h ON h.id = ha.hook_id WHERE ac.status = {ACK_STATUS} ORDER BY ac.last_retry ASC, ac.id ASC;";
}
internal class QRY_ACK_LC {
    public const string EXISTS_BY_ACK_ID = $@"SELECT 1 FROM lc_ack WHERE ack_id = {ACK_ID} LIMIT 1;";
    public const string EXISTS_BY_LC_ID = $@"SELECT 1 FROM lc_ack WHERE lc_id = {LC_ID} LIMIT 1;";

    public const string GET_BY_LC_ID = $@"SELECT * FROM lc_ack WHERE lc_id = {LC_ID} LIMIT 1;";
    public const string GET_BY_ACK_ID = $@"SELECT * FROM lc_ack WHERE ack_id = {ACK_ID} LIMIT 1;";
    public const string GET_ACK_ID_BY_LC_ID = $@"SELECT ack_id AS id FROM lc_ack WHERE lc_id = {LC_ID} LIMIT 1;";

    // idempotent attach (lc_id is PK)
    public const string ATTACH = $@"INSERT INTO lc_ack (ack_id, lc_id) VALUES ({ACK_ID}, {LC_ID}) ON DUPLICATE KEY UPDATE ack_id = ack_id;";
    public const string DETACH = $@"DELETE FROM lc_ack WHERE lc_id = {LC_ID};";

    public const string DELETE_BY_ACK_ID = $@"DELETE FROM lc_ack WHERE ack_id = {ACK_ID};";
    public const string DELETE_BY_LC_ID = $@"DELETE FROM lc_ack WHERE lc_id = {LC_ID};";

    public const string PENDING_ACKS = $@"SELECT a.id AS ack_id, a.guid AS ack_guid, ac.consumer, ac.status, ac.last_retry, ac.retry_count, l.* FROM lc_ack la JOIN ack a ON a.id = la.ack_id JOIN ack_consumer ac ON ac.ack_id = a.id JOIN lifecycle l ON l.id = la.lc_id WHERE ac.status = {ACK_STATUS} ORDER BY ac.last_retry ASC, ac.id ASC;";
}
internal class QRY_ACK_DISPATCH {

    public const string COUNT_DUE_LC = $@"SELECT COUNT(1) AS pending_count FROM lc_ack la JOIN ack_consumer ac ON ac.ack_id = la.ack_id WHERE ac.status = {ACK_STATUS} AND ac.next_due IS NOT NULL AND ac.next_due <= UTC_TIMESTAMP();";

    public const string COUNT_DUE_HOOK = $@"SELECT COUNT(1) AS pending_count FROM hook_ack ha JOIN ack_consumer ac ON ac.ack_id = ha.ack_id WHERE ac.status = {ACK_STATUS} AND ac.next_due IS NOT NULL AND ac.next_due <= UTC_TIMESTAMP();";

    public const string LIST_DUE_LC_PAGED = $@"SELECT a.id AS ack_id, a.guid AS ack_guid, a.created AS ack_created, ac.id AS ack_consumer_id, ac.consumer AS consumer, ac.status AS status, ac.last_trigger AS last_trigger, ac.trigger_count AS trigger_count, ac.next_due AS next_due, ac.created AS consumer_created, ac.modified AS consumer_modified, l.id AS lc_id, l.instance_id, i.def_version AS def_version_id, i.external_ref, l.from_state, l.to_state, l.event AS event_id, ev.code AS event_code, ev.display_name AS event_name, NULLIF(i.policy_id,0) AS policy_id, p.hash AS policy_hash, p.content AS policy_json, l.created AS lc_created, i.guid AS instance_guid, d.actor, d.payload FROM lc_ack la JOIN ack a ON a.id = la.ack_id JOIN ack_consumer ac ON ac.ack_id = a.id JOIN consumer c ON c.id = ac.consumer JOIN lifecycle l ON l.id = la.lc_id JOIN instance i ON i.id = l.instance_id JOIN events ev ON ev.id = l.event LEFT JOIN policy p ON p.id = NULLIF(i.policy_id,0) LEFT JOIN lc_data d ON d.lc_id = l.id WHERE ac.consumer = {CONSUMER_ID} AND ac.status = {ACK_STATUS} AND ac.next_due IS NOT NULL AND ac.next_due <= UTC_TIMESTAMP() AND TIMESTAMPDIFF(SECOND, c.last_beat, UTC_TIMESTAMP()) <= {TTL_SECONDS} ORDER BY ac.next_due ASC, l.id ASC, ac.id ASC LIMIT {TAKE} OFFSET {SKIP};";

    public const string LIST_DUE_HOOK_PAGED = $@"SELECT a.id AS ack_id, a.guid AS ack_guid, a.created AS ack_created, ac.id AS ack_consumer_id, ac.consumer AS consumer, ac.status AS status, ac.last_trigger AS last_trigger, ac.trigger_count AS trigger_count, ac.next_due AS next_due, ac.created AS consumer_created, ac.modified AS consumer_modified, ha.hook_id AS hook_id, h.instance_id AS instance_id, i.def_version AS def_version_id, i.external_ref AS external_ref, h.state_id AS state_id, h.via_event AS via_event, h.on_entry AS on_entry, h.route AS route, h.created AS hook_created, i.guid AS instance_guid FROM hook_ack ha JOIN ack a ON a.id = ha.ack_id JOIN ack_consumer ac ON ac.ack_id = a.id JOIN consumer c ON c.id = ac.consumer JOIN hook h ON h.id = ha.hook_id JOIN instance i ON i.id = h.instance_id WHERE ac.consumer = {CONSUMER_ID} AND ac.status = {ACK_STATUS} AND ac.next_due IS NOT NULL AND ac.next_due <= UTC_TIMESTAMP() AND TIMESTAMPDIFF(SECOND, c.last_beat, UTC_TIMESTAMP()) <= {TTL_SECONDS} ORDER BY ac.next_due ASC, h.id ASC, ac.id ASC LIMIT {TAKE} OFFSET {SKIP};";

}

    internal class QRY_DEFVERSION {
        public const string EXISTS_BY_ID = $@"SELECT 1 FROM def_version WHERE id = {ID} LIMIT 1;";
        public const string EXISTS_BY_GUID = $@"SELECT 1 FROM def_version WHERE guid = lower(trim({GUID})) LIMIT 1;";
        public const string EXISTS_BY_PARENT_AND_VERSION = $@"SELECT 1 FROM def_version WHERE parent = {PARENT_ID} AND version = {VERSION} LIMIT 1;";

        public const string GET_BY_ID = $@"SELECT dv.*, e.code AS env_code, d.name AS def_name FROM def_version dv JOIN definition d ON d.id = dv.parent JOIN environment e ON e.id = d.env WHERE dv.id = {ID} LIMIT 1;";
        public const string GET_BY_GUID = $@"SELECT dv.*, e.code AS env_code, d.name AS def_name FROM def_version dv JOIN definition d ON d.id = dv.parent JOIN environment e ON e.id = d.env WHERE dv.guid = lower(trim({GUID})) LIMIT 1;";
        public const string GET_LATEST_BY_PARENT = $@"SELECT dv.*, e.code AS env_code, d.name AS def_name FROM def_version dv JOIN definition d ON d.id = dv.parent JOIN environment e ON e.id = d.env WHERE dv.parent = {PARENT_ID} ORDER BY dv.version DESC LIMIT 1;";
        public const string GET_BY_PARENT_AND_HASH = $@"SELECT dv.*, e.code AS env_code, d.name AS def_name FROM def_version dv JOIN definition d ON d.id = dv.parent JOIN environment e ON e.id = d.env WHERE dv.parent = {PARENT_ID} AND dv.hash = lower(trim({HASH})) LIMIT 1;";

        public const string LIST_BY_PARENT = $@"SELECT * FROM def_version WHERE parent = {PARENT_ID} ORDER BY version DESC;";

        public const string INSERT = $@"INSERT INTO def_version (parent, version, data,hash) VALUES ({PARENT_ID}, {VERSION}, {DATA},lower(trim({HASH}))); SELECT LAST_INSERT_ID() AS id;";
        public const string UPDATE_DATA = $@"UPDATE def_version SET data = {DATA} WHERE id = {ID};";
        public const string DELETE = $@"DELETE FROM def_version WHERE id = {ID};";
        public const string DELETE_BY_PARENT = $@"DELETE FROM def_version WHERE parent = {PARENT_ID};";

        // 1) env (CODE) + definition NAME => latest def_version
        public const string GET_LATEST_BY_ENV_CODE_AND_DEF_NAME = $@"SELECT dv.*, e.code AS env_code, d.name AS def_name FROM def_version dv JOIN definition d ON d.id = dv.parent JOIN environment e ON e.id = d.env WHERE e.code = {CODE} AND d.name = lower(trim({NAME})) ORDER BY dv.version DESC LIMIT 1;";

        // 1b) env (NAME) + definition NAME => latest def_version
        // NOTE: using DISPLAY_NAME placeholder to pass env-name token (since env.name is generated from display_name)
        public const string GET_LATEST_BY_ENV_NAME_AND_DEF_NAME = $@"SELECT dv.*,e.code as env_code, d.name as def_name FROM def_version dv JOIN definition d ON d.id = dv.parent JOIN environment e ON e.id = d.env WHERE e.name = lower(trim({ENV_NAME})) AND d.name = lower(trim({DEF_NAME})) ORDER BY dv.version DESC LIMIT 1;";

        // 2) definition GUID => latest def_version
        public const string GET_LATEST_BY_DEFINITION_GUID = $@"SELECT dv.* FROM def_version dv JOIN definition d ON d.id = dv.parent WHERE d.guid = lower(trim({GUID})) ORDER BY dv.version DESC LIMIT 1;";

        // 3) def_version ID => latest def_version under the same parent
        public const string GET_LATEST_BY_LINE_FROM_DEFVERSION_ID = $@"SELECT dv2.* FROM def_version dv1 JOIN def_version dv2 ON dv2.parent = dv1.parent WHERE dv1.id = {ID} ORDER BY dv2.version DESC LIMIT 1;";

        // 3b) def_version GUID => latest def_version under the same parent
        public const string GET_LATEST_BY_LINE_FROM_DEFVERSION_GUID = $@"SELECT dv2.* FROM def_version dv1 JOIN def_version dv2 ON dv2.parent = dv1.parent WHERE dv1.guid = lower(trim({GUID})) ORDER BY dv2.version DESC LIMIT 1;";

        // 4) env CODE + definition NAME => next version number (max+1)
        public const string GET_NEXT_VERSION_BY_ENV_CODE_AND_DEF_NAME = $@"SELECT IFNULL(MAX(dv.version), 0) + 1 AS next_version FROM def_version dv JOIN definition d ON d.id = dv.parent JOIN environment e ON e.id = d.env WHERE e.code = {CODE} AND d.name = lower(trim({NAME})) LIMIT 1;";
    }
    internal class QRY_DEFINITION {
        public const string EXISTS_BY_ID = $@"SELECT 1 FROM definition WHERE id = {ID} LIMIT 1;";
        public const string EXISTS_BY_GUID = $@"SELECT 1 FROM definition WHERE guid = lower(trim({GUID})) LIMIT 1;";
        public const string EXISTS_BY_PARENT_AND_NAME = $@"SELECT 1 FROM definition WHERE env = {PARENT_ID} AND name = lower(trim({NAME})) LIMIT 1;";

        public const string GET_BY_ID = $@"SELECT * FROM definition WHERE id = {ID} LIMIT 1;";
        public const string GET_BY_GUID = $@"SELECT * FROM definition WHERE guid = lower(trim({GUID})) LIMIT 1;";
        public const string GET_BY_PARENT_AND_NAME = $@"SELECT * FROM definition WHERE env = {PARENT_ID} AND name = lower(trim({NAME})) LIMIT 1;";

        public const string LIST_BY_PARENT = $@"SELECT * FROM definition WHERE env = {PARENT_ID} ORDER BY id;";

        // NOTE: definition.name is GENERATED from display_name (do not set name)
        public const string INSERT = $@"INSERT INTO definition (env, display_name, description) VALUES ({PARENT_ID}, {DISPLAY_NAME}, {DESCRIPTION}); SELECT LAST_INSERT_ID() AS id;";
        public const string UPDATE = $@"UPDATE definition SET env = {PARENT_ID}, display_name = {DISPLAY_NAME}, description = {DESCRIPTION} WHERE id = {ID};";
        public const string DELETE = $@"DELETE FROM definition WHERE id = {ID};";
    }
    internal class QRY_ENVIRONMENT {
        public const string EXISTS_BY_ID = $@"SELECT 1 FROM environment WHERE id = {ID} LIMIT 1;";
        public const string EXISTS_BY_NAME = $@"SELECT 1 FROM environment WHERE name = lower(trim({NAME})) LIMIT 1;";
        public const string EXISTS_BY_CODE = $@"SELECT 1 FROM environment WHERE code = {CODE} LIMIT 1;";
        public const string EXISTS_BY_GUID = $@"SELECT 1 FROM environment WHERE guid = lower(trim({GUID})) LIMIT 1;";

        public const string GET_BY_ID = $@"SELECT * FROM environment WHERE id = {ID} LIMIT 1;";
        public const string GET_BY_NAME = $@"SELECT * FROM environment WHERE name = lower(trim({NAME})) LIMIT 1;";
        public const string GET_BY_CODE = $@"SELECT * FROM environment WHERE code = {CODE} LIMIT 1;";
        public const string GET_BY_GUID = $@"SELECT * FROM environment WHERE guid = lower(trim({GUID})) LIMIT 1;";

        public const string LIST_ALL = $@"SELECT * FROM environment ORDER BY id;";

        public const string INSERT = $@"INSERT INTO environment (display_name, code) VALUES ({DISPLAY_NAME}, {CODE}); SELECT LAST_INSERT_ID() AS id;";
        public const string UPDATE = $@"UPDATE environment SET display_name = {DISPLAY_NAME}, code = {CODE} WHERE id = {ID};";
        public const string DELETE = $@"DELETE FROM environment WHERE id = {ID};";
    }
    internal class QRY_POLICY {
        public const string EXISTS_BY_ID = $@"SELECT 1 FROM policy WHERE id = {ID} LIMIT 1;";
        public const string EXISTS_BY_HASH = $@"SELECT 1 FROM policy WHERE hash = lower(trim({HASH})) LIMIT 1;";

        public const string GET_BY_ID = $@"SELECT * FROM policy WHERE id = {ID} LIMIT 1;";
        public const string GET_BY_HASH = $@"SELECT * FROM policy WHERE hash = lower(trim({HASH})) LIMIT 1;";

        public const string INSERT = $@"INSERT INTO policy (hash, content) VALUES (lower(trim({HASH})), {CONTENT}); SELECT LAST_INSERT_ID() AS id;";

        // upsert: if exists -> update content, and always return the id
        public const string UPSERT_BY_HASH_RETURN_ID = $@"INSERT INTO policy (hash, content) VALUES (lower(trim({HASH})), {CONTENT}) ON DUPLICATE KEY UPDATE content = VALUES(content), id = LAST_INSERT_ID(id); SELECT LAST_INSERT_ID() AS id;";

        public const string UPDATE_CONTENT = $@"UPDATE policy SET content = {CONTENT} WHERE id = {ID};";
        public const string DELETE = $@"DELETE FROM policy WHERE id = {ID};";

        // def_policies: PRIMARY KEY(definition, policy) + column is "modified"
        public const string EXISTS_ATTACHMENT = $@"SELECT 1 FROM def_policies WHERE definition = {PARENT_ID} AND policy = {ID} LIMIT 1;";

        // If already attached, bump modified => tells you “this is latest attach”
        public const string ATTACH_TO_DEFINITION = $@"INSERT INTO def_policies (definition, policy) VALUES ({PARENT_ID}, {ID}) ON DUPLICATE KEY UPDATE modified = CURRENT_TIMESTAMP;";

        public const string DETACH_FROM_DEFINITION = $@"DELETE FROM def_policies WHERE definition = {PARENT_ID} AND policy = {ID};";

        public const string LIST_BY_DEFINITION = $@"SELECT p.*, dp.modified AS attached_modified FROM def_policies dp JOIN policy p ON p.id = dp.policy WHERE dp.definition = {PARENT_ID} ORDER BY dp.modified DESC, p.id ASC;";

        public const string GET_POLICY_FOR_DEFINITION = $@"SELECT p.*, dp.modified AS attached_modified FROM def_policies dp 
JOIN policy p ON p.id = dp.policy JOIN def_version dv ON dv.parent = dp.definition WHERE dp.definition = {PARENT_ID} ORDER BY dp.modified DESC, p.id DESC LIMIT 1;";

        public const string GET_POLICY_FOR_DEFVERSION = $@"SELECT p.*, dp.modified AS attached_modified FROM def_policies dp 
JOIN policy p ON p.id = dp.policy JOIN def_version dv ON dv.parent = dp.definition WHERE dv.id = {ID} ORDER BY dp.modified DESC, p.id DESC LIMIT 1;";

        // Latest policy lookups

        // A) definition id -> latest attached policy
        public const string GET_LATEST_BY_DEFINITION = $@"SELECT p.*, dp.modified AS attached_modified FROM def_policies dp JOIN policy p ON p.id = dp.policy WHERE dp.definition = {PARENT_ID} ORDER BY dp.modified DESC, p.id DESC LIMIT 1;";

        // B) definition guid -> latest attached policy
        public const string GET_LATEST_BY_DEFINITION_GUID = $@"SELECT p.*, dp.modified AS attached_modified FROM definition d JOIN def_policies dp ON dp.definition = d.id JOIN policy p ON p.id = dp.policy WHERE d.guid = lower(trim({GUID})) ORDER BY dp.modified DESC, p.id DESC LIMIT 1;";

        // C) env code + def name -> latest attached policy
        public const string GET_LATEST_BY_ENV_CODE_AND_DEF_NAME = $@"SELECT p.*, dp.modified AS attached_modified FROM environment e JOIN definition d ON d.env = e.id JOIN def_policies dp ON dp.definition = d.id JOIN policy p ON p.id = dp.policy WHERE e.code = {CODE} AND d.name = lower(trim({DEF_NAME})) ORDER BY dp.modified DESC, p.id DESC LIMIT 1;";

        // (optional) env name + def name -> latest attached policy
        // NOTE: using DISPLAY_NAME placeholder to pass env-name token (because env.name is generated)
        public const string GET_LATEST_BY_ENV_NAME_AND_DEF_NAME = $@"SELECT p.*, dp.modified AS attached_modified FROM environment e JOIN definition d ON d.env = e.id JOIN def_policies dp ON dp.definition = d.id JOIN policy p ON p.id = dp.policy WHERE e.name = lower(trim({ENV_NAME})) AND d.name = lower(trim({DEF_NAME})) ORDER BY dp.modified DESC, p.id DESC LIMIT 1;";

        // Optional: Attach by definition identifiers (no need to pre-fetch def.id)
        // Attach policy to definition by def GUID (idempotent: updates modified if exists)
        public const string ATTACH_TO_DEFINITION_BY_DEF_GUID = $@"INSERT INTO def_policies (definition, policy) SELECT d.id, {ID} FROM definition d WHERE d.guid = lower(trim({GUID})) LIMIT 1 ON DUPLICATE KEY UPDATE modified = CURRENT_TIMESTAMP;";

        // Attach policy to definition by env code + def name (idempotent)
        public const string ATTACH_TO_DEFINITION_BY_ENV_CODE_AND_DEF_NAME = $@"INSERT INTO def_policies (definition, policy) SELECT d.id, {ID} FROM definition d JOIN environment e ON e.id = d.env WHERE e.code = {CODE} AND d.name = lower(trim({DEF_NAME})) LIMIT 1 ON DUPLICATE KEY UPDATE modified = CURRENT_TIMESTAMP;";
    }
    internal static class QRY_CONSUMER {
        public const string GET_ID_BY_ENV_ID_AND_GUID = @$"SELECT id FROM consumer WHERE env={ENV_ID} AND consumer_guid=lower(trim({CONSUMER_GUID})) LIMIT 1;";
        public const string INSERT = @$"INSERT INTO consumer(env, consumer_guid, last_beat) VALUES({ENV_ID}, lower(trim({CONSUMER_GUID})), CURRENT_TIMESTAMP);";
        public const string UPDATE_BEAT_BY_ID = @$"UPDATE consumer SET last_beat=CURRENT_TIMESTAMP WHERE id={CONSUMER_ID};";
        public const string LIST_ALIVE_IDS_BY_ENV_ID = @$"SELECT id FROM consumer WHERE env={ENV_ID} AND TIMESTAMPDIFF(SECOND, last_beat, CURRENT_TIMESTAMP) <= {TTL_SECONDS};";
        public const string IS_ALIVE_BY_ID = @$"SELECT CASE WHEN TIMESTAMPDIFF(SECOND, last_beat, CURRENT_TIMESTAMP) <= {TTL_SECONDS} THEN 1 ELSE 0 END AS alive FROM consumer WHERE id={CONSUMER_ID};";

        public const string IS_ALIVE_BY_ENV_ID_AND_GUID = @$"SELECT CASE WHEN TIMESTAMPDIFF(SECOND, last_beat, CURRENT_TIMESTAMP) <= {TTL_SECONDS} THEN 1 ELSE 0 END AS alive FROM consumer WHERE env={ENV_ID} AND consumer_guid=lower(trim({CONSUMER_GUID})) LIMIT 1;";
        public const string GET_ID_ALIVE_BY_ENV_ID_AND_GUID = @$"SELECT id FROM consumer WHERE env={ENV_ID} AND consumer_guid=lower(trim({CONSUMER_GUID})) AND TIMESTAMPDIFF(SECOND, last_beat, CURRENT_TIMESTAMP) <= {TTL_SECONDS} LIMIT 1;";
        public const string GET_LAST_BEAT_BY_ENV_ID_AND_GUID = @$"SELECT last_beat FROM consumer WHERE env={ENV_ID} AND consumer_guid=lower(trim({CONSUMER_GUID})) LIMIT 1;";
        public const string UPSERT_BEAT_BY_ENV_ID_AND_GUID = @$"INSERT INTO consumer(env, consumer_guid, last_beat) VALUES({ENV_ID}, lower(trim({CONSUMER_GUID})), CURRENT_TIMESTAMP) ON DUPLICATE KEY UPDATE last_beat=CURRENT_TIMESTAMP;";
        public const string UPDATE_BEAT_BY_ENV_ID_AND_GUID = @$"UPDATE consumer SET last_beat=CURRENT_TIMESTAMP WHERE env={ENV_ID} AND consumer_guid=lower(trim({CONSUMER_GUID}));";

    }

    internal class QRY_INSTANCE {
    public const string EXISTS_BY_ID = $@"SELECT 1 FROM instance WHERE id = {ID} LIMIT 1;";
    public const string EXISTS_BY_GUID = $@"SELECT 1 FROM instance WHERE guid = lower(trim({GUID})) LIMIT 1;";
    public const string EXISTS_BY_PARENT_AND_EXTERNAL_REF = $@"SELECT 1 FROM instance WHERE def_version = {PARENT_ID} AND external_ref = trim({EXTERNAL_REF}) LIMIT 1;";

    // GUID-first lookups
    public const string GET_BY_GUID = $@"SELECT * FROM instance WHERE guid = lower(trim({GUID})) LIMIT 1;";
    public const string GET_BY_PARENT_AND_EXTERNAL_REF = $@"SELECT * FROM instance WHERE def_version = {PARENT_ID} AND external_ref = lower(trim({EXTERNAL_REF})) LIMIT 1;";

    public const string GET_ID_BY_GUID = $@"SELECT id FROM instance WHERE guid = lower(trim({GUID})) LIMIT 1;";

    public const string GET_BY_ID = $@"SELECT * FROM instance WHERE id = {ID} LIMIT 1;";
    public const string GET_GUID_BY_ID = $@"SELECT guid FROM instance WHERE id = {ID} LIMIT 1;";
    public const string GET_ID_BY_PARENT_AND_EXTERNAL_REF = $@"SELECT id FROM instance WHERE def_version = {PARENT_ID} AND external_ref = lower(trim({EXTERNAL_REF})) LIMIT 1;";
    public const string GET_GUID_BY_PARENT_AND_EXTERNAL_REF = $@"SELECT guid FROM instance WHERE def_version = {PARENT_ID} AND external_ref = lower(trim({EXTERNAL_REF})) LIMIT 1;";

    // lists should be chronological newest-first
    public const string LIST_BY_PARENT = $@"SELECT * FROM instance WHERE def_version = {PARENT_ID} ORDER BY created DESC, id DESC;";
    public const string LIST_BY_EXTERNAL_REF = $@"SELECT * FROM instance WHERE external_ref = lower(trim({EXTERNAL_REF})) ORDER BY created DESC, id DESC;";
    public const string LIST_BY_CURRENT_STATE = $@"SELECT * FROM instance WHERE current_state = {STATE_ID} ORDER BY created DESC, id DESC;";

    public const string LIST_WHERE_FLAGS_ANY = $@"SELECT * FROM instance WHERE (flags & {FLAGS}) <> 0 ORDER BY created DESC, id DESC;";
    public const string LIST_WHERE_FLAGS_NONE = $@"SELECT * FROM instance WHERE (flags & {FLAGS}) = 0 ORDER BY created DESC, id DESC;";

    // INSERT returns guid (first-class for external apps)
    public const string INSERT = $@"INSERT INTO instance (def_version, external_ref, current_state, last_event, policy_id, flags) VALUES ({PARENT_ID}, lower(trim({EXTERNAL_REF})), {STATE_ID}, {EVENT_ID}, {POLICY_ID}, {FLAGS}); SELECT guid FROM instance WHERE id = LAST_INSERT_ID() LIMIT 1;";

    // Note: constant name says RETURN_ID, but we now return GUID
    public const string UPSERT_BY_PARENT_AND_EXTERNAL_REF_RETURN_ID = $@"INSERT INTO instance (def_version, external_ref, current_state, last_event, policy_id, flags) VALUES ({PARENT_ID}, lower(trim({EXTERNAL_REF})), {STATE_ID}, {EVENT_ID}, {POLICY_ID}, {FLAGS}) ON DUPLICATE KEY UPDATE id = LAST_INSERT_ID(id); SELECT guid FROM instance WHERE id = LAST_INSERT_ID() LIMIT 1;";
    public const string UPSERT_BY_PARENT_AND_EXTERNAL_REF_RETURN_GUID = $@"INSERT INTO instance (def_version, external_ref, current_state, last_event, policy_id, flags) VALUES ({PARENT_ID}, lower(trim({EXTERNAL_REF})), {STATE_ID}, {EVENT_ID}, {POLICY_ID}, {FLAGS}) ON DUPLICATE KEY UPDATE id = LAST_INSERT_ID(id); SELECT guid AS guid FROM instance WHERE id = LAST_INSERT_ID() LIMIT 1;";

    public const string UPDATE_CURRENT_STATE = $@"UPDATE instance SET current_state = {STATE_ID}, last_event = {EVENT_ID} WHERE id = {ID};";
    public const string UPDATE_CURRENT_STATE_CAS = $@"UPDATE instance SET current_state = {TO_ID}, last_event = {EVENT_ID} WHERE id = {ID} AND current_state = {FROM_ID};";

    public const string SET_FLAGS = $@"UPDATE instance SET flags = {FLAGS} WHERE id = {ID};";
    public const string ADD_FLAGS = $@"UPDATE instance SET flags = (flags | {FLAGS}) WHERE id = {ID};";
    public const string REMOVE_FLAGS = $@"UPDATE instance SET flags = (flags & ~{FLAGS}) WHERE id = {ID};";

    public const string SET_POLICY = $@"UPDATE instance SET policy_id = {POLICY_ID} WHERE id = {ID};";
    public const string SET_EXTERNAL_REF = $@"UPDATE instance SET external_ref = lower(trim({EXTERNAL_REF})) WHERE id = {ID};";

    public const string DELETE = $@"DELETE FROM instance WHERE id = {ID};";

    public const string SET_MESSAGE_BY_ID = @$"UPDATE instance SET message={MESSAGE} WHERE id={INSTANCE_ID};";
    public const string SUSPEND_WITH_MESSAGE_BY_ID = @$"UPDATE instance SET flags=(flags | {FLAGS}), message={MESSAGE} WHERE id={INSTANCE_ID};";
    public const string FAIL_WITH_MESSAGE_BY_ID = @$"UPDATE instance SET flags=(flags | {FLAGS}), message={MESSAGE} WHERE id={INSTANCE_ID};";
    public const string CLEAR_MESSAGE_BY_ID = @$"UPDATE instance SET message=NULL WHERE id={INSTANCE_ID};";
    public const string UNSUSPEND_BY_ID = @$"UPDATE instance SET flags=(flags & ~{FLAGS}) WHERE id={INSTANCE_ID};";
    public const string CLEAR_FAILED_BY_ID = @$"UPDATE instance SET flags=(flags & ~{FLAGS}) WHERE id={INSTANCE_ID};";
    public const string COMPLETE_WITH_MESSAGE_BY_ID = @$"UPDATE instance SET flags=(flags | {FLAGS}), message={MESSAGE} WHERE id={INSTANCE_ID};";
    public const string CLEAR_COMPLETED_BY_ID = @$"UPDATE instance SET flags=(flags & ~{FLAGS}) WHERE id={INSTANCE_ID};";
    public const string ARCHIVE_WITH_MESSAGE_BY_ID = @$"UPDATE instance SET flags=(flags | {FLAGS}), message={MESSAGE} WHERE id={INSTANCE_ID};";
    public const string CLEAR_ARCHIVED_BY_ID = @$"UPDATE instance SET flags=(flags & ~{FLAGS}) WHERE id={INSTANCE_ID};";

    public const string GET_TIMELINE_JSON_BY_INSTANCE_ID = $@"SELECT JSON_OBJECT('instance', JSON_OBJECT('id', i.id, 'guid', i.guid, 'external_ref', i.external_ref, 'def_version', i.def_version, 'current_state', i.current_state, 'last_event', i.last_event, 'created', i.created, 'modified', i.modified), 'timeline', COALESCE((SELECT JSON_ARRAYAGG(t.j) FROM (SELECT JSON_OBJECT('lifecycle_id', l.id, 'created', l.created, 'from_state', sf.display_name, 'to_state', st.display_name, 'event', ev.display_name, 'event_code', ev.code, 'actor', ld.actor, 'activities', COALESCE((SELECT JSON_ARRAYAGG(a.j) FROM (SELECT JSON_OBJECT('runtime_id', r.id, 'lc_id', r.lc_id, 'state', rs.display_name, 'actor_id', r.actor_id, 'activity', act.display_name, 'status', ast.display_name, 'created', r.created, 'modified', r.modified, 'frozen', IF(r.frozen = 1, JSON_EXTRACT('true','$'), JSON_EXTRACT('false','$'))) AS j FROM runtime r JOIN state rs ON rs.id = r.state_id JOIN activity act ON act.id = r.activity JOIN activity_status ast ON ast.id = r.status WHERE r.instance_id = i.id AND r.lc_id = l.id ORDER BY r.modified DESC, r.id DESC) a), JSON_ARRAY())) AS j FROM lifecycle l JOIN state sf ON sf.id = l.from_state JOIN state st ON st.id = l.to_state JOIN events ev ON ev.id = l.event LEFT JOIN lc_data ld ON ld.lc_id = l.id WHERE l.instance_id = i.id ORDER BY l.created DESC, l.id DESC) t), JSON_ARRAY()), 'Other Activities', COALESCE((SELECT JSON_ARRAYAGG(o.j) FROM (SELECT JSON_OBJECT('runtime_id', r.id, 'lc_id', r.lc_id, 'state', rs.display_name, 'actor_id', r.actor_id, 'activity', act.display_name, 'status', ast.display_name, 'created', r.created, 'modified', r.modified, 'frozen', IF(r.frozen = 1, JSON_EXTRACT('true','$'), JSON_EXTRACT('false','$'))) AS j FROM runtime r JOIN state rs ON rs.id = r.state_id JOIN activity act ON act.id = r.activity JOIN activity_status ast ON ast.id = r.status WHERE r.instance_id = i.id AND (r.lc_id = 0 OR NOT EXISTS (SELECT 1 FROM lifecycle l2 WHERE l2.id = r.lc_id AND l2.instance_id = r.instance_id)) ORDER BY r.modified DESC, r.id DESC) o), JSON_ARRAY())) AS json FROM instance i WHERE i.id = {INSTANCE_ID} LIMIT 1;";


    public const string GET_TIMELINE_ROWSET_BY_INSTANCE_ID = $@"SELECT * FROM (SELECT 'timeline' AS block, l.id AS lifecycle_id, l.created AS lifecycle_created, sf.display_name AS from_state, st.display_name AS to_state, ev.display_name AS event, lcd.actor AS actor, r.id AS runtime_id, act.display_name AS activity, r.actor_id AS activity_actor_id, ast.display_name AS status, r.created AS activity_created, r.modified AS activity_modified, (r.frozen = 1) AS frozen, r.lc_id AS lc_id, NULL AS orphan_state FROM lifecycle l JOIN state sf ON sf.id = l.from_state JOIN state st ON st.id = l.to_state JOIN events ev ON ev.id = l.event LEFT JOIN lc_data lcd ON lcd.lc_id = l.id LEFT JOIN runtime r ON r.instance_id = l.instance_id AND r.lc_id = l.id LEFT JOIN activity act ON act.id = r.activity LEFT JOIN activity_status ast ON ast.id = r.status WHERE l.instance_id = {INSTANCE_ID} UNION ALL SELECT 'other_activities' AS block, NULL AS lifecycle_id, NULL AS lifecycle_created, NULL AS from_state, NULL AS to_state, NULL AS event, NULL AS actor, r.id AS runtime_id, act.display_name AS activity, r.actor_id AS activity_actor_id, ast.display_name AS status, r.created AS activity_created, r.modified AS activity_modified, (r.frozen = 1) AS frozen, r.lc_id AS lc_id, s.display_name AS orphan_state FROM runtime r JOIN activity act ON act.id = r.activity JOIN activity_status ast ON ast.id = r.status LEFT JOIN state s ON s.id = r.state_id WHERE r.instance_id = {INSTANCE_ID} AND (r.lc_id = 0 OR NOT EXISTS (SELECT 1 FROM lifecycle l2 WHERE l2.id = r.lc_id AND l2.instance_id = r.instance_id))) x ORDER BY CASE WHEN x.block = 'timeline' THEN 0 ELSE 1 END, x.lifecycle_created DESC, x.activity_modified DESC;";

}
internal class QRY_HOOK {
    public const string EXISTS_BY_ID = $@"SELECT 1 FROM hook WHERE id = {ID} LIMIT 1;";
    public const string EXISTS_BY_KEY = $@"SELECT 1 FROM hook WHERE instance_id = {INSTANCE_ID} AND state_id = {STATE_ID} AND via_event = {EVENT_ID} AND on_entry = {ON_ENTRY} AND route = {ROUTE} LIMIT 1;";

    public const string GET_BY_ID = $@"SELECT * FROM hook WHERE id = {ID} LIMIT 1;";
    public const string GET_BY_KEY =
    $@"SELECT * FROM hook WHERE instance_id = {INSTANCE_ID} AND state_id = {STATE_ID} AND via_event = {EVENT_ID} AND on_entry = {ON_ENTRY} AND route = {ROUTE}  LIMIT 1;";
    public const string LIST_BY_INSTANCE = $@"SELECT * FROM hook WHERE instance_id = {INSTANCE_ID} ORDER BY created DESC, id DESC;";
    public const string LIST_BY_INSTANCE_AND_STATE = $@"SELECT * FROM hook WHERE instance_id = {INSTANCE_ID} AND state_id = {STATE_ID} ORDER BY created DESC, id DESC;";
    public const string LIST_BY_INSTANCE_STATE_ENTRY = $@"SELECT * FROM hook WHERE instance_id = {INSTANCE_ID} AND state_id = {STATE_ID} AND on_entry = {ON_ENTRY} ORDER BY created DESC, id DESC;";

    public const string INSERT = $@"INSERT INTO hook (instance_id, state_id, via_event, on_entry, route) VALUES ({INSTANCE_ID}, {STATE_ID}, {EVENT_ID}, {ON_ENTRY}, {ROUTE}); SELECT LAST_INSERT_ID() AS id;";

    public const string UPSERT_BY_KEY_RETURN_ID = $@"INSERT INTO hook (instance_id, state_id, via_event, on_entry, route) VALUES ({INSTANCE_ID}, {STATE_ID}, {EVENT_ID}, {ON_ENTRY}, {ROUTE}) ON DUPLICATE KEY UPDATE id = LAST_INSERT_ID(id); SELECT LAST_INSERT_ID() AS id;";

    public const string DELETE = $@"DELETE FROM hook WHERE id = {ID};";
    public const string DELETE_BY_INSTANCE = $@"DELETE FROM hook WHERE instance_id = {INSTANCE_ID};";
}
internal class QRY_LC_DATA {
    public const string EXISTS_BY_ID = $@"SELECT 1 FROM lc_data WHERE lc_id = {ID} LIMIT 1;";
    public const string GET_BY_ID = $@"SELECT * FROM lc_data WHERE lc_id = {ID} LIMIT 1;";

    // lc_id is the PK; return it as id for consistency
    public const string UPSERT = $@"INSERT INTO lc_data (lc_id, actor, payload) VALUES ({ID}, {ACTOR}, {PAYLOAD}) ON DUPLICATE KEY UPDATE actor = VALUES(actor), payload = VALUES(payload); SELECT {ID} AS id;";

    public const string DELETE = $@"DELETE FROM lc_data WHERE lc_id = {ID};";
}
internal class QRY_LIFECYCLE {
    public const string EXISTS_BY_ID = $@"SELECT 1 FROM lifecycle WHERE id = {ID} LIMIT 1;";

    public const string GET_BY_ID = $@"SELECT * FROM lifecycle WHERE id = {ID} LIMIT 1;";
    public const string GET_LAST_BY_INSTANCE = $@"SELECT * FROM lifecycle WHERE instance_id = {INSTANCE_ID} ORDER BY created DESC, id DESC LIMIT 1;";

    public const string LIST_BY_INSTANCE = $@"SELECT * FROM lifecycle WHERE instance_id = {INSTANCE_ID} ORDER BY created DESC, id DESC;";
    public const string LIST_BY_INSTANCE_PAGED = $@"SELECT * FROM lifecycle WHERE instance_id = {INSTANCE_ID} ORDER BY created DESC, id DESC LIMIT {TAKE} OFFSET {SKIP};";

    public const string INSERT = $@"INSERT INTO lifecycle (from_state, to_state, event, instance_id) VALUES ({FROM_ID}, {TO_ID}, {EVENT_ID}, {INSTANCE_ID}); SELECT LAST_INSERT_ID() AS id;";

    public const string DELETE = $@"DELETE FROM lifecycle WHERE id = {ID};";
    public const string DELETE_BY_INSTANCE = $@"DELETE FROM lifecycle WHERE instance_id = {INSTANCE_ID};";
}

    internal class QRY_LC_TIMEOUT {

        public const string EXISTS_BY_LC_ID = $@"SELECT 1 FROM lc_timeout WHERE lc_id = {LC_ID} LIMIT 1;";
        public const string INSERT_IGNORE = $@"INSERT IGNORE INTO lc_timeout (lc_id) VALUES ({LC_ID});";
        public const string DELETE_BY_LC_ID = $@"DELETE FROM lc_timeout WHERE lc_id = {LC_ID};";

        // Due timeouts (no record yet) based on latest lifecycle entry == current state
        // NOTE: requires each instance to have at least one lifecycle row for current_state 
        public const string LIST_DUE_PAGED = $@"SELECT i.id AS instance_id, i.guid AS instance_guid, i.external_ref AS external_ref, i.def_version AS def_version_id, i.current_state AS state_id, l.id AS entry_lc_id, l.created AS entered_at, tm.duration AS timeout_duration, tm.mode AS timeout_mode, tm.event_code AS timeout_event_code, DATE_ADD(l.created, INTERVAL tm.duration MINUTE) AS due_at FROM instance i JOIN lifecycle l ON l.id = (SELECT MAX(l2.id) FROM lifecycle l2 WHERE l2.instance_id = i.id) JOIN state s ON s.id = i.current_state AND s.def_version = i.def_version JOIN timeouts tm ON tm.policy_id = i.policy_id AND tm.state_name = s.name LEFT JOIN lc_timeout lt ON lt.lc_id = l.id WHERE (i.flags & {FLAGS}) = 0 AND l.to_state = i.current_state AND tm.duration > 0 AND tm.event_code IS NOT NULL AND lt.lc_id IS NULL AND DATE_ADD(l.created, INTERVAL tm.duration MINUTE) <= UTC_TIMESTAMP() ORDER BY due_at ASC, i.id ASC LIMIT {TAKE} OFFSET {SKIP};";

    }

internal static class QRY_TIMEOUTS {

    public const string DELETE_BY_POLICY_ID = $@"DELETE FROM timeouts WHERE policy_id = {POLICY_ID};";

    public const string INSERT = $@"INSERT INTO timeouts (policy_id, state_name, duration, mode, event_code) VALUES ({POLICY_ID}, {STATE_NAME}, {DURATION}, {MODE}, {EVENT_CODE});";

    public const string LIST_BY_POLICY_ID = $@"SELECT policy_id, state_name, duration, mode, event_code FROM timeouts WHERE policy_id = {POLICY_ID} ORDER BY state_name ASC;";
}


 internal class QRY_RUNTIME {
     public const string EXISTS_BY_ID = $@"SELECT 1 FROM runtime WHERE id = {ID} LIMIT 1;";
     public const string EXISTS_BY_KEY = $@"SELECT 1 FROM runtime WHERE instance_id = {INSTANCE_ID} AND state_id = {STATE_ID} AND activity = {ACTIVITY_ID} AND actor_id = trim({ACTOR_ID}) LIMIT 1;";

     public const string GET_BY_ID = $@"SELECT * FROM runtime WHERE id = {ID} LIMIT 1;";
     public const string GET_BY_KEY = $@"SELECT * FROM runtime WHERE instance_id = {INSTANCE_ID} AND state_id = {STATE_ID} AND activity = {ACTIVITY_ID} AND actor_id = trim({ACTOR_ID}) LIMIT 1;";

     // list newest activity updates first
     public const string LIST_BY_INSTANCE = $@"SELECT * FROM runtime WHERE instance_id = {INSTANCE_ID} ORDER BY modified DESC, id DESC;";
     public const string LIST_BY_INSTANCE_AND_STATE = $@"SELECT * FROM runtime WHERE instance_id = {INSTANCE_ID} AND state_id = {STATE_ID} ORDER BY modified DESC, id DESC;";
     public const string LIST_BY_INSTANCE_STATE_ACTIVITY = $@"SELECT * FROM runtime WHERE instance_id = {INSTANCE_ID} AND state_id = {STATE_ID} AND activity = {ACTIVITY_ID} ORDER BY modified DESC, id DESC;";

     // (new) list by lifecycle
     public const string LIST_BY_LIFECYCLE = $@"SELECT * FROM runtime WHERE lc_id = {LC_ID} ORDER BY modified DESC, id DESC;";

     public const string INSERT = $@"INSERT INTO runtime (instance_id, activity, state_id, actor_id, status, frozen, lc_id) VALUES ({INSTANCE_ID}, {ACTIVITY_ID}, {STATE_ID}, trim({ACTOR_ID}), {STATUS_ID}, {FROZEN}, {LC_ID}); SELECT LAST_INSERT_ID() AS id;";

     // If frozen=1 => do not change status/lc_id/modified; still return id
     public const string UPSERT_BY_KEY_RETURN_ID = $@"INSERT INTO runtime (instance_id, activity, state_id, actor_id, status, frozen, lc_id) VALUES ({INSTANCE_ID}, {ACTIVITY_ID}, {STATE_ID}, trim({ACTOR_ID}), {STATUS_ID}, {FROZEN}, {LC_ID}) ON DUPLICATE KEY UPDATE status = IF(frozen = 0, VALUES(status), status), lc_id = IF(frozen = 0 AND VALUES(lc_id) <> 0, VALUES(lc_id), lc_id), frozen = IF(frozen = 0, VALUES(frozen), frozen), modified = IF(frozen = 0, CURRENT_TIMESTAMP(), modified), id = LAST_INSERT_ID(id); SELECT LAST_INSERT_ID() AS id;";

     public const string SET_STATUS = $@"UPDATE runtime SET status = {STATUS_ID}, modified = CURRENT_TIMESTAMP() WHERE id = {ID} AND frozen = 0;";
     public const string SET_LC_ID = $@"UPDATE runtime SET lc_id = {LC_ID}, modified = CURRENT_TIMESTAMP() WHERE id = {ID} AND frozen = 0;";

     public const string FREEZE = $@"UPDATE runtime SET frozen = 1, modified = CURRENT_TIMESTAMP() WHERE id = {ID};";
     public const string UNFREEZE = $@"UPDATE runtime SET frozen = 0, modified = CURRENT_TIMESTAMP() WHERE id = {ID};";

     public const string DELETE = $@"DELETE FROM runtime WHERE id = {ID};";
     public const string DELETE_BY_INSTANCE = $@"DELETE FROM runtime WHERE instance_id = {INSTANCE_ID};";
 }

 internal class QRY_RUNTIME_DATA {
     public const string EXISTS_BY_ID = $@"SELECT 1 FROM runtime_data WHERE runtime = {ID} LIMIT 1;";
     public const string GET_BY_ID = $@"SELECT * FROM runtime_data WHERE runtime = {ID} LIMIT 1;";

     // runtime is PK; return it as id for consistency
     public const string UPSERT = $@"INSERT INTO runtime_data (runtime, data, payload) VALUES ({ID}, {DATA}, {PAYLOAD}) ON DUPLICATE KEY UPDATE data = VALUES(data), payload = VALUES(payload); SELECT {ID} AS id;";

     public const string DELETE = $@"DELETE FROM runtime_data WHERE runtime = {ID};";
 }

 internal class QRY_ACTIVITY {
     public const string EXISTS_BY_ID = $@"SELECT 1 FROM activity WHERE id = {ID} LIMIT 1;";
     public const string EXISTS_BY_NAME = $@"SELECT 1 FROM activity WHERE name = lower(trim({NAME})) LIMIT 1;";

     public const string GET_BY_ID = $@"SELECT * FROM activity WHERE id = {ID} LIMIT 1;";
     public const string GET_BY_NAME = $@"SELECT * FROM activity WHERE name = lower(trim({NAME})) LIMIT 1;";

     public const string LIST_ALL = $@"SELECT * FROM activity ORDER BY id;";

     // NOTE: activity.name is GENERATED from display_name (do not set name)
     public const string INSERT = $@"INSERT INTO activity (display_name) VALUES ({DISPLAY_NAME}); SELECT LAST_INSERT_ID() AS id;";
     public const string UPDATE = $@"UPDATE activity SET display_name = {DISPLAY_NAME} WHERE id = {ID};";
     public const string DELETE = $@"DELETE FROM activity WHERE id = {ID};";
 }

 internal class QRY_ACTIVITY_STATUS {
     public const string EXISTS_BY_ID = $@"SELECT 1 FROM activity_status WHERE id = {ID} LIMIT 1;";
     public const string EXISTS_BY_NAME = $@"SELECT 1 FROM activity_status WHERE name = lower(trim({NAME})) LIMIT 1;";

     public const string GET_BY_ID = $@"SELECT * FROM activity_status WHERE id = {ID} LIMIT 1;";
     public const string GET_BY_NAME = $@"SELECT * FROM activity_status WHERE name = lower(trim({NAME})) LIMIT 1;";

     public const string LIST_ALL = $@"SELECT * FROM activity_status ORDER BY id;";

     // NOTE: activity_status.name is GENERATED from display_name (do not set name)
     public const string INSERT = $@"INSERT INTO activity_status (display_name) VALUES ({DISPLAY_NAME}); SELECT LAST_INSERT_ID() AS id;";
     public const string UPDATE = $@"UPDATE activity_status SET display_name = {DISPLAY_NAME} WHERE id = {ID};";
     public const string DELETE = $@"DELETE FROM activity_status WHERE id = {ID};";
 }

    internal class QRY_STATE {
        public const string EXISTS_BY_ID = $@"SELECT 1 FROM state WHERE id = {ID} LIMIT 1;";
        public const string EXISTS_BY_PARENT_AND_NAME = $@"SELECT 1 FROM state WHERE def_version = {PARENT_ID} AND name = lower(trim({NAME})) LIMIT 1;";

        public const string GET_BY_ID = $@"SELECT * FROM state WHERE id = {ID} LIMIT 1;";
        public const string GET_BY_PARENT_AND_NAME = $@"SELECT * FROM state WHERE def_version = {PARENT_ID} AND name = lower(trim({NAME})) LIMIT 1;";

        public const string LIST_BY_PARENT = $@"SELECT * FROM state WHERE def_version = {PARENT_ID} ORDER BY id;";

        // keep join safe: s.* plus unique category aliases (avoid duplicate column keys)
        public const string LIST_BY_PARENT_WITH_CATEGORY = $@"SELECT s.*, c.display_name AS category_display_name, c.name AS category_name FROM state s LEFT JOIN category c ON c.id = s.category WHERE s.def_version = {PARENT_ID} ORDER BY s.id;";

        // NOTE: state.name is GENERATED from display_name (do not set name)
        public const string INSERT = $@"INSERT INTO state (def_version, display_name, category, flags) VALUES ({PARENT_ID}, {DISPLAY_NAME}, {CATEGORY_ID}, {FLAGS}); SELECT LAST_INSERT_ID() AS id;";

        public const string UPDATE = $@"UPDATE state SET display_name = {DISPLAY_NAME}, category = {CATEGORY_ID}, flags = {FLAGS} WHERE id = {ID};";

        public const string DELETE = $@"DELETE FROM state WHERE id = {ID};";
        public const string DELETE_BY_PARENT = $@"DELETE FROM state WHERE def_version = {PARENT_ID};";
    }


 internal class QRY_TRANSITION {
     public const string EXISTS_BY_ID = $@"SELECT 1 FROM transition WHERE id = {ID} LIMIT 1;";
     public const string EXISTS_BY_KEY = $@"SELECT 1 FROM transition WHERE def_version = {PARENT_ID} AND from_state = {FROM_ID} AND to_state = {TO_ID} AND event = {EVENT_ID} LIMIT 1;";

     public const string GET_BY_ID = $@"SELECT * FROM transition WHERE id = {ID} LIMIT 1;";
     public const string GET_BY_KEY = $@"SELECT * FROM transition WHERE def_version = {PARENT_ID} AND from_state = {FROM_ID} AND to_state = {TO_ID} AND event = {EVENT_ID} LIMIT 1;";
     public const string GET_BY_FROM_AND_EVENT = $@"SELECT * FROM transition WHERE def_version = {PARENT_ID} AND from_state = {FROM_ID} AND event = {EVENT_ID} ORDER BY id LIMIT 1;";

     public const string LIST_BY_PARENT = $@"SELECT t.*, 0 AS flags FROM transition t WHERE t.def_version = {PARENT_ID} ORDER BY t.id;";

     public const string INSERT = $@"INSERT INTO transition (def_version, from_state, to_state, event) VALUES ({PARENT_ID}, {FROM_ID}, {TO_ID}, {EVENT_ID}); SELECT LAST_INSERT_ID() AS id;";
     public const string UPDATE = $@"UPDATE transition SET from_state = {FROM_ID}, to_state = {TO_ID}, event = {EVENT_ID} WHERE id = {ID};";
     public const string DELETE = $@"DELETE FROM transition WHERE id = {ID};";
     public const string DELETE_BY_PARENT = $@"DELETE FROM transition WHERE def_version = {PARENT_ID};";
 }

 internal class QRY_EVENTS {
     public const string EXISTS_BY_ID = $@"SELECT 1 FROM events WHERE id = {ID} LIMIT 1;";
     public const string EXISTS_BY_PARENT_AND_CODE = $@"SELECT 1 FROM events WHERE def_version = {PARENT_ID} AND code = {CODE} LIMIT 1;";
     public const string EXISTS_BY_PARENT_AND_NAME = $@"SELECT 1 FROM events WHERE def_version = {PARENT_ID} AND name = lower(trim({NAME})) LIMIT 1;";

     public const string GET_BY_ID = $@"SELECT * FROM events WHERE id = {ID} LIMIT 1;";
     public const string GET_BY_PARENT_AND_CODE = $@"SELECT * FROM events WHERE def_version = {PARENT_ID} AND code = {CODE} LIMIT 1;";
     public const string GET_BY_PARENT_AND_NAME = $@"SELECT * FROM events WHERE def_version = {PARENT_ID} AND name = lower(trim({NAME})) LIMIT 1;";

     public const string LIST_BY_PARENT = $@"SELECT * FROM events WHERE def_version = {PARENT_ID} ORDER BY id;";

     // NOTE: events.name is GENERATED from display_name (do not set name)
     public const string INSERT = $@"INSERT INTO events (def_version, display_name, code) VALUES ({PARENT_ID}, {DISPLAY_NAME}, {CODE}); SELECT LAST_INSERT_ID() AS id;";
     public const string UPDATE = $@"UPDATE events SET display_name = {DISPLAY_NAME}, code = {CODE} WHERE id = {ID};";
     public const string DELETE = $@"DELETE FROM events WHERE id = {ID};";
     public const string DELETE_BY_PARENT = $@"DELETE FROM events WHERE def_version = {PARENT_ID};";
 }

 internal class QRY_CATEGORY {
     public const string EXISTS_BY_ID = $@"SELECT 1 FROM category WHERE id = {ID} LIMIT 1;";
     public const string EXISTS_BY_NAME = $@"SELECT 1 FROM category WHERE name = lower(trim({NAME})) LIMIT 1;";

     public const string GET_BY_ID = $@"SELECT * FROM category WHERE id = {ID} LIMIT 1;";
     public const string GET_BY_NAME = $@"SELECT * FROM category WHERE name = lower(trim({NAME})) LIMIT 1;";

     public const string LIST_ALL = $@"SELECT * FROM category ORDER BY id;";

     // NOTE: category.name is GENERATED from display_name (do not set name)
     public const string INSERT = $@"INSERT INTO category (display_name) VALUES ({DISPLAY_NAME}); SELECT LAST_INSERT_ID() AS id;";
     public const string UPDATE = $@"UPDATE category SET display_name = {DISPLAY_NAME} WHERE id = {ID};";
     public const string DELETE = $@"DELETE FROM category WHERE id = {ID};";
 }


  internal class QueryFields {
     public const string ID = "@ID";
     public const string PARENT_ID = "@PARENT_ID";

     public const string NAME = "@NAME";
     public const string CODE = "@CODE";
     public const string GUID = "@GUID";
     public const string HASH = "@HASH";
     public const string CATEGORY_ID = "@CATEGORY_ID";
     public const string POLICY_ID = "@POLICY_ID";
     public const string STATE_NAME = "@STATE_NAME";

     public const string DURATION = "@DURATION";
     public const string MODE = "@MODE";
     public const string EVENT_CODE = "@EVENT_CODE";

     public const string DISPLAY_NAME = "@DISPLAY_NAME";
     public const string DESCRIPTION = "@DESCRIPTION";
     public const string CONTENT = "@CONTENT";
     public const string DATA = "@DATA";
     public const string PAYLOAD = "@PAYLOAD";
     public const string VERSION = "@VERSION";
     public const string DEF_NAME = "@DEF_NAME";
     public const string ENV_NAME = "@ENV_NAME";
     public const string FROZEN = "@FROZEN";

     public const string INSTANCE_ID = "@INSTANCE_ID";
     public const string EXTERNAL_REF = "@EXTERNAL_REF";
     public const string CONSUMER = "@CONSUMER";
     public const string MAX_RETRY = "@MAX_RETRY";
     public const string RECHECK_SECONDS = "@RECHECK_SECONDS";

     public const string STATE_ID = "@STATE_ID";
     public const string FROM_ID = "@FROM_ID";
     public const string TO_ID = "@TO_ID";
     public const string EVENT_ID = "@EVENT_ID";

     public const string FLAGS = "@FLAGS";

     public const string ACTOR = "@ACTOR";
     public const string ACTOR_ID = "@ACTOR_ID";

     public const string ON_ENTRY = "@ON_ENTRY";
     public const string ROUTE = "@ROUTE";

     public const string ACK_ID = "@ACK_ID";
     public const string LC_ID = "@LC_ID";
     public const string ENV_ID = "@ENV_ID";
     public const string HOOK_ID = "@HOOK_ID";
     public const string TTL_SECONDS = "@TTL_SECONDS";
     public const string CONSUMER_ID = "@CONSUMER_ID";
     public const string CONSUMER_GUID = "@CONSUMER_GUID";
     public const string SOURCE_ID = "@SOURCE_ID";
     public const string ACK_STATUS = "@ACK_STATUS";
     public const string OLDER_THAN = "@OLDER_THAN";
     public const string NEXT_DUE = "@NEXT_DUE";
     public const string MESSAGE = "@MESSAGE";

     public const string ACTIVITY_ID = "@ACTIVITY_ID";
     public const string STATUS_ID = "@STATUS_ID";

     public const string TAKE = "@TAKE";
     public const string SKIP = "@SKIP";
 }
  